name: CI/CD Pipeline

on:
  push:
    branches:
      - ws_teste

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Check if 'type:' and 'descriptions:' exist in *.sqlx files
        run: |
          if grep -r "type:" --include="*.sqlx" . && grep -r "descriptions:" --include="*.sqlx" .; then
            echo "As palavras 'type:' e 'descriptions:' foram encontradas nos arquivos sqlx."
          else
            echo "As palavras 'type:' e 'descriptions:' NÃƒO foram encontradas nos arquivos sqlx."
            exit 1
          fi

      - name: Merge ws_teste into development
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git checkout development
          git pull origin development
          git merge origin/ws_teste --no-ff -m "Merge ws_teste into development"
          git push origin development

  upload-to-gcs:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Check active user
        run: |
          gcloud auth list
          gcloud config list

      - name: Authenticate with Google Cloud
        run: |
          echo "${{ secrets.GCP_SA_KEY }}" > /tmp/gcp-key.json
          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
          gcloud config set project <SEU_PROJETO_GCP>

      - name: Copy files from qa/ to Google Cloud Storage
        run: |
          gsutil -m cp -r qa/* gs://bucket-6133-20241008_2/cicdqa/
