name: CI/CD Pipeline

on:
  push:
    branches:
      - ws_teste

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Check if 'type:' and 'descriptions:' exist in *.sqlx files
        run: |
          if grep -r "type:" --include="*.sqlx" . && grep -r "descriptions:" --include="*.sqlx" .; then
            echo "As palavras 'type:' e 'descriptions:' foram encontradas nos arquivos sqlx."
          else
            echo "As palavras 'type:' e 'descriptions:' NO foram encontradas nos arquivos sqlx."
            exit 1
          fi

      - name: Merge ws_teste into development
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git checkout development
          git pull origin development
          git merge origin/ws_teste --no-ff -m "Merge ws_teste into development"
          git push origin development

sync_to_dataform:
  runs-on: ubuntu-latest
  needs: build  # Garante que s贸 roda ap贸s o job "build" terminar com sucesso

  steps:
    - name: Checkout c贸digo do reposit贸rio atual
      uses: actions/checkout@v2
      with:
        fetch-depth: 0  # Garante que todo o hist贸rico est谩 dispon铆vel

    - name: Checkout do reposit贸rio de destino (dataform)
      uses: actions/checkout@v2
      with:
        repository: seu-usuario/dataform  #  Substitua pelo reposit贸rio correto
        token: ${{ secrets.GITHUB_TOKEN }}  #  Usa o token de acesso para permiss玫es
        path: dataform_repo  # Faz o checkout em uma pasta separada

    - name: Copiar arquivos do diret贸rio "qa" para o reposit贸rio "dataform"
      run: |
        cp -r qa/* dataform_repo/  # Copia todos os arquivos do qa para o reposit贸rio "dataform"

    - name: Configurar nome de usu谩rio e email para o commit
      run: |
        cd dataform_repo
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

    - name: Commit e Push das mudan莽as para o reposit贸rio "dataform"
      run: |
        cd dataform_repo
        git add .
        git commit -m "Atualizando arquivos do diret贸rio 'qa' via CI/CD"
        git push origin main  #  Altere para a branch correta do reposit贸rio destino

